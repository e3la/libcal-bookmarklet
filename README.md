# libcal-bookmarklet
A bookmarklet to block out dates on a libcal calendar when your library is closed.

# LibCal Hours to ICS Bookmarklet

A simple, powerful bookmarklet to generate an `.ics` calendar file of library closure dates from your library's hours page (it should work if your library is using the sprinshare hours tool). This allows librarians to easily block off appointment availability on days the library is closed.

## The Problem

LibCal is a fantastic tool for managing library services, including librarian appointments. However, the appointment availability module doesn't automatically sync with the library's operating hours. This means that if the library is closed for a holiday or a break, librarians have to go in and manually block off those dates to prevent patrons from booking appointments (this is if you are using the Outlook/Exchange integration) and you can't just put the day as 'busy', you have to block out specific hours. That is where this bookmarklet comes in handy by automating the most tedious part of the process. 

## The Motivation

Andrew explained he didn't have a secretary and that he would not be blocking out day's the library was closed. I thought this sad, so I made this bookmarklet for Andrew.

## What is This?

This tool is a **bookmarklet**â€”a piece of JavaScript code saved as a browser bookmark. When you are on your library's website, clicking this bookmark will:

1.  Fetch library hours data.
2.  Provide a user-friendly interface to select which library's closures you want to export to your calendar.
3.  Allow you to customize the time range to block off and the event title.
4.  Generate a standard `.ics` calendar file that you can download and open in outlook to block the days the library is closed.

This project was developed using a **"vibecoding"** approach, where the initial structure and logic were generated by prompting an AI assistant, and then refined and tested to create the final, functional tool.

## Features

*   **Zero Configuration:** Automatically detects the necessary LibCal ID from the page.
*   **Multi-Location Support:** Choose to export closed dates for a single library location or all locations at once.
*   **Custom Time Blocking:** Specify the exact time range you want to block on closed days (e.g., from 8:00 AM to 9:00 PM).
*   **Custom Event Titles:** Add a custom prefix to the calendar events (e.g., "Appointments Blocked").
*   **Weekend Control:** Easily include or exclude weekend closures from your export.
*   **Summary Screen:** Review which dates will be included or left out before you download.
*   **Standard ICS Format:** The generated file is compatible with LibCal, Outlook, Google Calendar, and other standard calendar applications.

## Installation

You can install the bookmarklet in two ways. The drag-and-drop method is the easiest. Visit the website for that method. Otherwise:

### Manual Installation

If the drag-and-drop method doesn't work, you can always install it manually.

1.  **Create a New Bookmark:** Right-click on your browser's bookmarks bar and select "Add Page" (on Chrome/Edge) or "New Bookmark" (on Firefox).
2.  **Name the Bookmark:** In the "Name" field, give it a memorable name, like `LibCal Blocker`.
3.  **Paste the Code:** Copy the entire code block below and paste it into the **URL** or **Location** field of the bookmark editor.

```javascript
javascript:(function() { 'use strict'; console.log("Bookmarklet: Starting."); try { let IID = null; function findLibCalIID() { console.log("Bookmarklet: Searching for LibCal IID."); const pageText = document.documentElement.innerHTML; const match = pageText.match(/iid:\s*['"]?(\d+)[%27"]?/); if (match) { console.log("Bookmarklet: Found IID -> " + match); return match; } console.error("Bookmarklet: IID not found on page."); return null; } function jsonpRequest(url, callback) { console.log("Bookmarklet: Preparing to fetch data from -> " + url); const callbackName = 'jsonp_callback_' + Math.floor(Math.random() * 100000); const script = document.createElement('script'); window[callbackName] = function(data) { console.log("Bookmarklet: Successfully received API data."); document.body.removeChild(script); delete window[callbackName]; callback(null, data); }; script.onerror = () => { console.error("Bookmarklet: API request failed. The website's Content Security Policy (CSP) may be blocking it."); document.body.removeChild(script); delete window[callbackName]; callback(new Error('Could not fetch library hours from the API. The website may be blocking this request. Please check the developer console (F12) for CSP errors.')); }; script.src = `${url}&callback=${callbackName}`; document.body.appendChild(script); } function buildUI(hoursData) { console.log("Bookmarklet: Building user interface."); if (document.getElementById('libcal-ics-overlay')) return; const style = document.createElement('style'); style.id = 'libcal-ics-styler'; style.innerHTML = `.libcal-custom-select { position: relative; } .libcal-select-selected { background-color: white; color: #333; padding: 9px 12px; border: 1px solid #ced4da; border-radius: 6px; cursor: pointer; user-select: none; } .libcal-select-selected:after { position: absolute; content: ""; top: 16px; right: 12px; width: 0; height: 0; border: 6px solid transparent; border-color: #343a40 transparent transparent transparent; } .libcal-select-selected.select-arrow-active:after { border-color: transparent transparent #343a40 transparent; top: 9px; } .libcal-select-items { position: absolute; background-color: white; top: 100%; left: 0; right: 0; z-index: 99; border: 1px solid #ced4da; border-top: none; border-radius: 0 0 6px 6px; max-height: 200px; overflow-y: auto; } .libcal-select-items div { color: black; padding: 9px 12px; cursor: pointer; user-select: none; } .libcal-select-items div:hover, .same-as-selected { background-color: #e9ecef; } .libcal-select-hide { display: none; } .summary-list { border: 1px solid #dee2e6; border-radius: 6px; max-height: 120px; overflow-y: auto; padding: 8px 12px; font-size: 13px; } .summary-list div { padding: 2px 0; } .summary-list-title { margin-bottom: 6px; font-size: 14px; color: #555; font-weight: 500; }`; document.head.appendChild(style); const overlay = document.createElement('div'); overlay.id = 'libcal-ics-overlay'; overlay.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:9999; display:flex; justify-content:center; align-items:center;'; const modal = document.createElement('div'); modal.style.cssText = 'background:white; padding: 24px; border-radius:8px; font-family:system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; max-width:400px; width:90%; box-shadow: 0 5px 20px rgba(0,0,0,0.2);'; modal.innerHTML = `<div id="libcal-options"><h3 style="margin-top:0; margin-bottom: 24px; color:#222; font-size: 22px; font-weight: 600;">Generate Library Calendar</h3><label style="display:block; margin-bottom:6px; font-size:14px; color:#555; font-weight: 500;">Select Library:</label><div id="libcal-custom-select" class="libcal-custom-select" style="margin-bottom: 20px;"><div class="libcal-select-selected" data-value="all">All Found Libraries</div><div class="libcal-select-items libcal-select-hide"><div data-value="all">All Found Libraries</div> ${hoursData.locations.map(location => `<div data-value="${location.lid}">${location.name}</div>`).join('')}</div></div><div style="display:flex; flex-direction:column; gap:18px; margin-bottom:28px;"><div><div style="padding-left:2px; margin-bottom:6px;"><label style="font-size:14px; color:#555; font-weight: 500;">Block time from:</label></div><div style="display:flex; gap: 8px; align-items:center;"><input type="time" id="closed-start-time" value="06:00" style="padding: 8px 10px; border: 1px solid #ced4da; border-radius: 6px; font-size:14px; width: 100%;"><span style="font-size:14px; color:#555;">to</span><input type="time" id="closed-end-time" value="23:00" style="padding: 8px 10px; border: 1px solid #ced4da; border-radius: 6px; font-size:14px; width: 100%;"></div></div><div><label for="custom-title-text" style="display:block; margin-bottom:6px; font-size:14px; color:#555; font-weight: 500;">Custom Title Prefix:</label><input type="text" id="custom-title-text" value="block appointments" style="width:100%; box-sizing: border-box; padding:8px 12px; border:1px solid #ced4da; border-radius:6px; font-size:14px;"></div></div><div style="display:flex; justify-content:flex-end; gap:10px;"><button id="libcal-cancel" style="padding:10px 16px; cursor:pointer; background:#f8f9fa; border:1px solid #ced4da; border-radius:6px; font-size:14px; font-weight: 500;">Cancel</button><button id="libcal-generate" style="padding:10px 16px; border:none; background:#0d6efd; color:white; border-radius:6px; cursor:pointer; font-size:14px; font-weight: 500;">Generate Summary</button></div></div><div id="libcal-summary" style="display:none;"></div>`; overlay.appendChild(modal); document.body.appendChild(overlay); const selectedDisplay = overlay.querySelector('.libcal-select-selected'); const optionsContainer = overlay.querySelector('.libcal-select-items'); selectedDisplay.addEventListener('click', function(e) { e.stopPropagation(); optionsContainer.classList.toggle('libcal-select-hide'); this.classList.toggle('select-arrow-active'); }); for (const option of optionsContainer.children) { option.addEventListener('click', function() { selectedDisplay.innerHTML = this.innerHTML; selectedDisplay.setAttribute('data-value', this.getAttribute('data-value')); optionsContainer.classList.add('libcal-select-hide'); selectedDisplay.classList.remove('select-arrow-active'); }); } document.addEventListener('click', () => { optionsContainer.classList.add('libcal-select-hide'); selectedDisplay.classList.remove('select-arrow-active'); }); overlay.querySelector('#libcal-cancel').addEventListener('click', cleanup); overlay.querySelector('#libcal-generate').addEventListener('click', () => prepareSummary(hoursData)); } function formatTimeFromInput(date, timeInput) { const year = date.getUTCFullYear(); const month = (date.getUTCMonth() + 1).toString().padStart(2, '0'); const day = date.getUTCDate().toString().padStart(2, '0'); const [hours, minutes] = timeInput.split(':'); return `${year}${month}${day}T${hours}${minutes}00`; } function prepareSummary(hoursData) { console.log("Bookmarklet: Preparing generation summary."); const userOptions = { selectedValue: document.querySelector('#libcal-custom-select .libcal-select-selected').getAttribute('data-value'), customTitleText: document.getElementById('custom-title-text').value.trim(), startTime: document.getElementById('closed-start-time').value, endTime: document.getElementById('closed-end-time').value }; if (!userOptions.startTime || !userOptions.endTime) { alert("Please select a valid start and end time."); return; } const weekdayEvents = []; const weekendEvents = []; const locationsToProcess = (userOptions.selectedValue === 'all') ? hoursData.locations : hoursData.locations.filter(loc => loc.lid == userOptions.selectedValue); locationsToProcess.forEach(location => { if (location.weeks) { location.weeks.forEach(week => { for (const day in week) { if (Object.hasOwnProperty.call(week, day)) { const dayInfo = week[day]; if (dayInfo.times.status === 'closed') { const date = new Date(dayInfo.date); const dayOfWeek = date.getUTCDay(); const eventData = { date: date, location: location, dayInfo: dayInfo }; if (dayOfWeek === 0 || dayOfWeek === 6) { weekendEvents.push(eventData); } else { weekdayEvents.push(eventData); } } } } }); } }); document.getElementById('libcal-options').style.display = 'none'; document.getElementById('libcal-summary').style.display = 'block'; displaySummaryUI(weekdayEvents, weekendEvents, userOptions, hoursData); } function displaySummaryUI(weekdayEvents, weekendEvents, userOptions, hoursData) { const summaryContainer = document.getElementById('libcal-summary'); summaryContainer.innerHTML = `<h3 style="margin-top:0; margin-bottom: 24px; color:#222; font-size: 22px; font-weight: 600;">Generation Summary</h3><div style="display:flex; align-items:center; margin-bottom: 20px;"><input type="checkbox" id="include-weekends-checkbox" style="margin-right:9px; width:15px; height:15px; accent-color: #0d6efd;"><label for="include-weekends-checkbox" style="font-size:14px; color:#555; font-weight: 500;">Include Weekends</label></div><div style="display:flex; flex-direction:column; gap: 15px; margin-bottom: 28px;"><div><div class="summary-list-title">Dates to be Included:</div><div id="included-dates" class="summary-list"></div></div><div><div class="summary-list-title">Dates Left Out:</div><div id="left-out-dates" class="summary-list"></div></div></div><div style="display:flex; justify-content:flex-end; gap:10px;"><button id="libcal-back" style="padding:10px 16px; cursor:pointer; background:#f8f9fa; border:1px solid #ced4da; border-radius:6px; font-size:14px; font-weight: 500;">Back</button><button id="libcal-download" style="padding:10px 16px; border:none; background:#0d6efd; color:white; border-radius:6px; cursor:pointer; font-size:14px; font-weight: 500;">Download ICS</button></div>`; const includeWeekendsCheckbox = summaryContainer.querySelector('#include-weekends-checkbox'); const includedContainer = summaryContainer.querySelector('#included-dates'); const leftOutContainer = summaryContainer.querySelector('#left-out-dates'); const days = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday']; const formatDateForDisplay = (date) => { const dayName = days[date.getUTCDay()]; return `${date.getUTCMonth() + 1}/${date.getUTCDate()}/${date.getUTCFullYear()} (${dayName})`; }; const updateLists = () => { const includeWeekends = includeWeekendsCheckbox.checked; const included = includeWeekends ? [...weekdayEvents, ...weekendEvents] : weekdayEvents; const leftOut = includeWeekends ? [] : weekendEvents; included.sort((a, b) => a.date - b.date); leftOut.sort((a, b) => a.date - b.date); includedContainer.innerHTML = included.map(e => `<div>${e.location.name} - ${formatDateForDisplay(e.date)}</div>`).join('') || "<div>None</div>"; leftOutContainer.innerHTML = leftOut.map(e => `<div>${e.location.name} - ${formatDateForDisplay(e.date)}</div>`).join('') || "<div>None</div>"; }; includeWeekendsCheckbox.addEventListener('change', updateLists); updateLists(); summaryContainer.querySelector('#libcal-back').addEventListener('click', () => { document.getElementById('libcal-summary').style.display = 'none'; document.getElementById('libcal-options').style.display = 'block'; }); summaryContainer.querySelector('#libcal-download').addEventListener('click', () => { const includeWeekends = includeWeekendsCheckbox.checked; const eventsToInclude = includeWeekends ? [...weekdayEvents, ...weekendEvents] : weekdayEvents; generateAndDownloadICS(eventsToInclude, userOptions, hoursData); }); } function generateAndDownloadICS(eventsToInclude, userOptions, hoursData) { console.log("Bookmarklet: Generating and downloading ICS file."); let icsContent = 'BEGIN:VCALENDAR\nVERSION:2.0\nPRODID:-//LibCal//Bookmarklet//EN\n'; eventsToInclude.sort((a, b) => a.date - b.date); eventsToInclude.forEach((eventData, index) => { const { date, location } = eventData; const startDate = formatTimeFromInput(date, userOptions.startTime); const endDate = formatTimeFromInput(date, userOptions.endTime); const uid_prefix = `${date.getUTCFullYear()}${(date.getUTCMonth() + 1).toString().padStart(2, '0')}${date.getUTCDate().toString().padStart(2, '0')}`; const customText = userOptions.customTitleText || 'block appointments'; let summary = `${customText} - ${location.name} Closed`; icsContent += 'BEGIN:VEVENT\n'; icsContent += `DTSTART;TZID=America/Chicago:${startDate}\n`; icsContent += `DTEND;TZID=America/Chicago:${endDate}\n`; icsContent += `SUMMARY:${summary}\n`; icsContent += `UID:${uid_prefix}-closed-${location.lid}@libcal\n`; if (index === eventsToInclude.length - 1) { icsContent += 'DESCRIPTION:This is the last event from this import. Remember to run the bookmarklet again to get new dates and block more days.\\n\n'; icsContent += 'BEGIN:VALARM\n'; icsContent += 'TRIGGER:-PT15M\n'; icsContent += 'ACTION:DISPLAY\n'; icsContent += 'DESCRIPTION:Reminder: Run the library bookmarklet to block more days.\n'; icsContent += 'END:VALARM\n'; } icsContent += 'END:VEVENT\n'; }); icsContent += 'END:VCALENDAR'; const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' }); const link = document.createElement('a'); let fileName = 'library_closed_days'; if (userOptions.selectedValue !== 'all') { const selectedLocation = hoursData.locations.find(loc => loc.lid == userOptions.selectedValue); if (selectedLocation) fileName = selectedLocation.name.replace(/\W+/g, '_'); } link.href = URL.createObjectURL(blob); link.download = `${fileName}.ics`; document.body.appendChild(link); link.click(); document.body.removeChild(link); cleanup(); } function cleanup() { console.log("Bookmarklet: Cleaning up UI."); const overlay = document.getElementById('libcal-ics-overlay'); if (overlay) document.body.removeChild(overlay); const styler = document.getElementById('libcal-ics-styler'); if (styler) document.head.removeChild(styler); } function main() { IID = findLibCalIID(); if (!IID) { alert('Could not find a LibCal Institution ID (IID) on this page.'); return; } const hoursUrl = `https://api3.libcal.com/api_hours_grid.php?iid=${IID}&lid=0&format=json&weeks=52`; jsonpRequest(hoursUrl, (err, data) => { if (err) { alert(err.message); return; } if (!data || !data.locations || data.locations.length === 0) { alert('No library locations found in the API response.'); return; } buildUI(data); }); } main(); } catch (e) { console.error("Bookmarklet: A critical error occurred:", e); alert("A critical error occurred. Please check the developer console (F12) for details. Error: " + e.message); } })();
```

## How to Use

1.  **Navigate to Your Library's Website:** Go to any page on your library's website that is powered by LibCal (like the homepage, hours page, or calendar).
2.  **Click the Bookmarklet:** Click the `LibCal Blocker` bookmark in your bookmarks bar.
3.  **Choose Your Options:** A modal window will appear.
    *   Select the library location you want to generate the file for, or choose "All Found Libraries".
    *   Set the "Block time from" and "to" fields to cover your typical appointment hours.
    *   Customize the event title prefix if desired.
    *   Click "Generate Summary".
4.  **Review and Download:**
    *   On the summary screen, you can see a list of dates that will be included in the `.ics` file.
    *   Check the "Include Weekends" box if you need to block off Saturdays and Sundays.
    *   When you're ready, click "Download ICS".
5.  **Import to LibCal:**
    *   Go to your LibCal dashboard.
    *   Navigate to `Appointments` -> `Availability`.
    *   Under the `Date & Time Availability` section, find the `Add new busy/unavailable times` link and click it.
    *   Select the **"Upload a File"** option.
    *   Choose the `.ics` file you just downloaded.
    *   The dates will be added to your schedule, blocking off your availability.

That's it! You have successfully blocked off all closed dates in just a few clicks.

## Public Domain Code - CC0

This is a public domain work because the ai did the heavy lift in the creation.

## License

This project is released under the [MIT License](LICENSE).
